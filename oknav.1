.\" OKnav System Manual Page
.\" Generated: 2025-12-22
.\"
.TH OKNAV 1 "December 2025" "OKnav 2.3.0" "User Commands"
.\"
.SH NAME
oknav \- SSH orchestration system for multi-server command execution
.\"
.SH SYNOPSIS
.B oknav
.RI [ OPTIONS ]
.I command
.br
.B oknav
.RI [ OPTIONS ]
.B \-\-
.I command
.br
.B oknav install
.RI [ OPTIONS ]
.br
.B oknav list
.RI [ \-R "] [" \-p ]
.br
.B oknav add
.RI [ \-n ]
.I hostname
.RI [ alias... ]
.br
.B oknav remove
.RI [ \-n ]
.IR alias ...
.br
.I ALIAS
.RI [ OPTIONS ]
.RI [ command... ]
.\"
.SH DESCRIPTION
.B OKnav
is a lightweight SSH orchestration system providing two modes of operation:
.TP
.B Cluster Operations
The
.B oknav
command executes commands across all servers marked with the
.B (oknav)
option in
.IR hosts.conf .
Supports sequential (default) and parallel execution modes.
.TP
.B Individual Server Access
Symlinks to
.B ok_master
(e.g.,
.IR srv1 ", " srv2 )
provide enhanced SSH access to specific servers with user switching
and directory preservation.
.PP
Server mappings are defined in
.I hosts.conf
which associates FQDNs with aliases and options.
.\"
.SH COMMANDS
.SS oknav \- Cluster Orchestrator
Execute commands across all servers with the
.B (oknav)
option in hosts.conf.
.PP
.B oknav
.RI [ OPTIONS ]
.I command
.RS
Execute
.I command
on all cluster servers. By default, servers are processed sequentially.
Use
.B \-p
for parallel execution.
.RE
.PP
.B oknav install
.RI [ OPTIONS ]
.RS
Create symlinks in
.I /usr/local/bin
for all aliases defined in hosts.conf.
.RE
.PP
.B oknav add
.I hostname
.RI [ alias... ]
.RS
Create ad-hoc launcher symlinks for
.I hostname
without editing hosts.conf. If no aliases are specified, the hostname
is used as the alias. Requires sudo. The hostname must be resolvable
via DNS or /etc/hosts.
.RE
.PP
.B oknav remove
.IR alias ...
.RS
Remove ad-hoc launcher symlinks created by
.BR "oknav add" .
Only removes symlinks pointing to ok_master. Requires sudo.
.RE
.PP
.B oknav list
.RS
List all host symlinks in
.I /usr/local/bin
pointing to ok_master. Shows whether each host is defined in hosts.conf
or was added ad-hoc via
.BR "oknav add" .
.RE
.PP
.B oknav
.RI [ OPTIONS ]
.B \-\-
.I command
.RS
Force multi-execute mode, bypassing subcommand detection. Use this when
.I command
matches a subcommand name (install, add, remove, list). For example,
.B "oknav \-\- list /tmp"
executes
.I "list /tmp"
on all servers instead of running the list subcommand.
.RE
.\"
.SS ok_master \- Individual Server Handler
Invoked through symlinks, provides SSH access to individual servers.
The target server is determined by the invocation name (the symlink name).
.PP
.I ALIAS
.RI [ OPTIONS ]
.RI [ command... ]
.RS
Connect to the server associated with
.I ALIAS
in hosts.conf. If no command is provided, starts an interactive shell.
.RE
.\"
.SH OPTIONS
.SS oknav Options
.TP
.BR \-p ", " \-\-parallel
Execute commands in parallel across all servers. Output is collected
and displayed in server order after all complete.
.TP
.BR \-t ", " \-\-timeout " " \fISECS\fR
Set connection timeout in seconds. Default is 30.
.TP
.BR \-x ", " \-\-exclude\-host " " \fIHOST\fR
Exclude
.I HOST
from this execution. Can be specified multiple times.
.TP
.BR \-D ", " \-\-debug
Enable debug output showing server discovery, execution mode, and settings.
.TP
.BR \-V ", " \-\-version
Display version information and exit.
.TP
.BR \-h ", " \-\-help
Display help message and exit.
.\"
.SS oknav install Options
.TP
.BR \-n ", " \-\-dry\-run
Show what would be done without making changes.
.TP
.B \-\-remove\-stale
Remove symlinks in
.I /usr/local/bin
that point to ok_master but are not defined in hosts.conf.
.TP
.B \-\-clean\-local
Remove symlinks from the script directory (except
.BR oknav ).
.TP
.BR \-h ", " \-\-help
Display install help and exit.
.\"
.SS oknav add Options
.TP
.BR \-n ", " \-\-dry\-run
Show what would be done without making changes.
.TP
.BR \-h ", " \-\-help
Display add help and exit.
.\"
.SS oknav remove Options
.TP
.BR \-n ", " \-\-dry\-run
Show what would be done without making changes.
.TP
.BR \-h ", " \-\-help
Display remove help and exit.
.\"
.SS oknav list Options
.TP
.BR \-R ", " \-\-reachable
Test each host for SSH connectivity. Uses a 5-second timeout per host.
Displays a checkmark or cross symbol indicating connectivity status.
.TP
.BR \-p ", " \-\-parallel
Test hosts in parallel. Use with
.B \-R
for faster results when checking many hosts.
.TP
.BR \-h ", " \-\-help
Display list help and exit.
.\"
.SS ok_master Options (Individual Server)
.TP
.BR \-r ", " \-\-root
Connect as root user. Shortcut for
.BR "\-u root" .
.TP
.BR \-u ", " \-\-user " " \fIUSER\fR
Connect as
.IR USER .
Default is the current user.
.TP
.BR \-d ", " \-\-dir
Preserve current working directory on remote server. The directory
must exist on the remote system.
.TP
.BR \-D ", " \-\-debug
Show connection parameters (ALIAS, USER, SERVER, CMD, etc.) to stderr.
.TP
.BR \-V ", " \-\-version
Display version information and exit.
.TP
.BR \-h ", " \-\-help
Display help message and exit.
.\"
.SH CONFIGURATION
.SS hosts.conf Format
Server mappings are defined in
.I hosts.conf
which is searched in this order:
.I /etc/oknav/hosts.conf
(system-wide), then the script directory (development).
.PP
.RS
.I FQDN
.I primary-alias
.RI [ alias2... ]
.RI [( options )]
.RE
.PP
.TP
.I FQDN
The fully qualified domain name or hostname of the server.
.TP
.I primary-alias
The first alias is the canonical name used for cluster operations.
.TP
.I alias2...
Additional aliases for the same server.
.TP
.I options
Comma-separated options in parentheses.
.\"
.SS hosts.conf Options
.TP
.B oknav
Include this server in cluster operations. Only the
.B first
(primary) alias is used when running
.BR oknav .
.TP
.B exclude
Exclude from cluster operations even if
.B oknav
is set. The server remains accessible directly.
.TP
.BI local\-only: HOSTNAME
Restrict access to this server. Connection is only permitted when
the current machine's hostname matches
.IR HOSTNAME .
.\"
.SS hosts.conf Example
.PP
.nf
.RS
# Production servers
server1.example.com   srv1 server1   (oknav)
server2.example.com   srv2 server2   (oknav)

# Development (restricted to workstation)
devbox.local          dev devbox     (oknav,local-only:workstation)

# Backup (excluded from cluster ops)
backup.local          bak backup     (oknav,exclude)

# Ad-hoc server (direct access only)
adhoc.example.com     adhoc
.RE
.fi
.\"
.SH EXIT STATUS
.TP
.B 0
Success.
.TP
.B 1
General error, including unknown alias or hosts.conf issues.
.TP
.B 2
Local-only constraint violated (ok_master only). The server is
restricted to a specific host and the current hostname does not match.
.TP
.B 22
Invalid command-line option (EINVAL).
.TP
.B 124
Connection timeout reached.
.TP
.B 125
Timeout command error.
.TP
.B 126
Command not found (server unreachable).
.\"
.SH ENVIRONMENT
.TP
.B OKNAV_HOSTS_CONF
Override path to hosts.conf. Primarily used for testing.
Takes precedence over default search paths.
.TP
.B OKNAV_TARGET_DIR
Override the target directory for
.BR "oknav list" .
Defaults to
.IR /usr/local/bin .
Primarily used for testing.
.TP
.B XDG_RUNTIME_DIR
Used for temporary files in parallel mode. Falls back to
.I /tmp
if unavailable.
.TP
.B USER
Default SSH user for ok_master connections.
.TP
.B HOSTNAME
Current machine hostname, used for
.B local-only
constraint checking.
.\"
.SH FILES
.TP
.I /etc/oknav/hosts.conf
System-wide server configuration file defining FQDNs, aliases, and options.
This is the primary configuration location after installation.
During installation, existing files are preserved. If missing, the installer
uses
.I hosts.conf
from the source directory (for local installs), or
.I hosts.conf.example
as a template.
.TP
.I /usr/local/share/oknav/
Package directory containing the installed scripts:
.BR oknav ", " ok_master ", " common.inc.sh .
.TP
.I /usr/local/bin/oknav
Cluster orchestrator (symlink to /usr/local/share/oknav/oknav).
.TP
.I /usr/local/bin/*
Server alias symlinks created by
.BR "oknav install" ,
pointing to
.IR /usr/local/share/oknav/ok_master .
.TP
.I /usr/local/share/man/man1/oknav.1
This manual page.
.TP
.I /etc/bash_completion.d/oknav
Bash completion script for tab completion support.
.\"
.SH EXAMPLES
.SS Individual Server Access
.TP
.B srv1
Start interactive shell on srv1.
.TP
.B srv1 uptime
Execute
.I uptime
on srv1.
.TP
.B srv1 \-r
Start root shell on srv1.
.TP
.B srv1 \-u admin whoami
Execute
.I whoami
as admin user.
.TP
.B srv1 \-rd
Root shell preserving current directory.
.TP
.B srv1 \-D hostname
Debug mode showing connection parameters.
.\"
.SS Cluster Operations
.TP
.B oknav uptime
Check uptime on all cluster servers (sequential).
.TP
.B oknav \-p uptime
Check uptime on all servers in parallel.
.TP
.B oknav \-t 60 'apt update'
Update packages with 60-second timeout.
.TP
.B oknav \-x srv1 hostname
Execute on all servers except srv1.
.TP
.B oknav \-pt 10 uptime
Parallel execution with 10-second timeout.
.TP
.B oknav \-D hostname
Debug mode showing discovered servers.
.\"
.SS Symlink Management
.TP
.B sudo oknav install
Create symlinks in /usr/local/bin for all aliases.
.TP
.B oknav install \-\-dry\-run
Preview symlink changes without making them.
.TP
.B sudo oknav install \-\-remove\-stale
Remove orphaned symlinks not in hosts.conf.
.\"
.SS Ad-hoc Launchers
.TP
.B sudo oknav add ai.okusi.id
Create launcher using hostname as alias.
.TP
.B sudo oknav add ai.okusi.id ai ok\-ai
Create launchers with custom aliases.
.TP
.B oknav add \-n ai.okusi.id
Preview what add would do.
.TP
.B sudo oknav remove ai ok\-ai
Remove ad-hoc launchers.
.\"
.SS Listing Hosts
.TP
.B oknav list
List all installed host symlinks with their source (hosts.conf or ad-hoc).
.TP
.B oknav list \-\-reachable
List hosts and test SSH connectivity (5-second timeout per host).
.TP
.B oknav list \-R \-p
Test connectivity in parallel for faster results.
.\"
.SS Bypassing Subcommands
Use
.B \-\-
to execute commands that match subcommand names:
.TP
.B oknav \-\- list /tmp
Execute 'list /tmp' on all servers (not the list subcommand).
.TP
.B oknav \-p \-\- install
Parallel execute 'install' command on all servers.
.\"
.SS Output Format
Cluster operations prefix each server's output:
.PP
.nf
.RS
$ oknav uptime
+++srv1:
 10:15:23 up 45 days,  3:22,  2 users

+++srv2:
 10:15:24 up 32 days, 14:55,  0 users
.RE
.fi
.\"
.SH SEE ALSO
.BR ssh (1),
.BR sudo (8),
.BR timeout (1)
.\"
.SH BUGS
Report bugs at the project repository.
.\"
.SH AUTHORS
OKnav was developed for server cluster management.
