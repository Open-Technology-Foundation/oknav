#!/bin/bash
# ==============================================================================
# OKnav System - Individual Server SSH Connection Handler
# ==============================================================================
# Invoked via symlinks (ok0, srv1, etc.) to connect to specific servers.
# The symlink name determines the target: ok0 → lookup in hosts.conf → FQDN.
# If not in hosts.conf, the symlink name is used directly as hostname.
#
# Exit codes:
#   0   Success (or help/version displayed)
#   1   General error
#   2   Local-only constraint violation
#   22  Invalid option (EINVAL)
#
# See also: oknav (cluster orchestrator), common.inc.sh (shared lib)
# ==============================================================================
set -euo pipefail
shopt -s inherit_errexit

SCRIPT_PATH=$(readlink -en -- "$0")
SCRIPT_DIR=${SCRIPT_PATH%/*}
SCRIPT_NAME=${SCRIPT_PATH##*/}
readonly -- SCRIPT_PATH SCRIPT_DIR SCRIPT_NAME

#shellcheck source=common.inc.sh
source "$SCRIPT_DIR"/common.inc.sh || exit 1

# ------------------------------------------------------------------------------
# Configuration (derived from invocation and options)
# ------------------------------------------------------------------------------
declare -- SERVER=${0##*/}         # Target: symlink name, NOT readlink result
declare -- USER=${USER:-root}      # SSH user (current user or root fallback)
declare -- CURDIR=''               # Remote directory (-d preserves PWD)
declare -- CMD=''                  # Remote command (empty = interactive shell)
declare -- SSHOPTS=''              # SSH options (-t for interactive)

usage() {
  cat <<EOT
$SERVER $VERSION - SSH connection handler

Connect to server via symlink name. The name is resolved via hosts.conf
to get the FQDN. If not in hosts.conf, the name is used as hostname.

Usage:
  $SERVER [OPTIONS] [COMMAND...]    Execute command on remote server
  $SERVER [OPTIONS]                 Start interactive shell session

Options:
  -r, --root        Connect as root (shortcut for -u root)
  -u, --user USER   Connect as specified user (default: current user)
  -d, --dir         Preserve current working directory on remote
  -D, --debug       Show connection parameters
  -V, --version     Show version
  -h, --help        Show this help

Examples:
  $SERVER uptime                    Execute 'uptime' command
  $SERVER -r systemctl status       Check services as root
  $SERVER -rd                       Root shell in current directory
  $SERVER -u deploy -d git pull     Pull code as deploy user
  $SERVER -D whoami                 Debug: show connection details

Resolution Order:
  1. hosts.conf lookup: $SERVER → FQDN (with constraint checking)
  2. If not found: use $SERVER directly as hostname

EOT
}

# ------------------------------------------------------------------------------
# Option Parsing (supports combined short options: -rd → -r -d)
# ------------------------------------------------------------------------------
while (($#)); do
  case $1 in
    -u|--user)  shift; USER="${1:-$USER}" ;;
    -r|--root)  USER=root ;;
    -d|--dir)   CURDIR="$PWD" ;;
    -D|--debug) DEBUG=1 ;;
    -V|--version) echo "$SCRIPT_NAME $VERSION"; exit 0 ;;
    -h|--help) usage; exit 0 ;;
    -[urdDVh]*)
      # Expand combined options: -rd → -r -d
      #shellcheck disable=SC2046
      set -- '' $(printf -- '-%c ' $(grep -o . <<<"${1:1}")) "${@:2}" ;;
    -*) die 22 "Invalid option ${1@Q}" ;;
    *)  CMD="$*"; break ;;  # Remaining args form the remote command
  esac
  shift
done

# ------------------------------------------------------------------------------
# Server Resolution: symlink name → FQDN via hosts.conf
# Returns: 0 found, 1 not found (use as hostname), 2 constraint violation
# ------------------------------------------------------------------------------
load_hosts_conf
declare -- ALIAS="$SERVER"
SERVER=$(resolve_alias "$ALIAS") || {
  case $? in
    1) SERVER="$ALIAS" ;;  # Not in hosts.conf: use alias as hostname
    2) exit 2 ;;           # Local-only constraint violated (error printed)
  esac
}

# ------------------------------------------------------------------------------
# Command Setup: interactive shell vs command execution
# ------------------------------------------------------------------------------
if [[ -z "$CMD" ]]; then
  CMD='exec bash'
  SSHOPTS='-t'  # Pseudo-terminal for interactive session
fi

# Prepend cd if -d option used (path escaped for special chars)
[[ -z "$CURDIR" ]] || CMD="cd $(printf %q "$CURDIR") && $CMD"

# Debug: show all connection parameters
if ((DEBUG)); then
  debug "Connection parameters:"
  #shellcheck disable=SC2090,SC2089
  >&2 declare -p ALIAS USER SERVER CURDIR CMD SSHOPTS
fi

# ------------------------------------------------------------------------------
# Execute SSH (exec replaces this process)
# ------------------------------------------------------------------------------
exec /usr/bin/ssh $SSHOPTS "${USER}@${SERVER}" "$CMD"

#fin
